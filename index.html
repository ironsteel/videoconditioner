<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Videoconditioner by svofski</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Videoconditioner</h1>
        <p>RGB video input for Altera DE1 board + PAL Modulator</p>

        <p class="view"><a href="https://github.com/svofski/videoconditioner">View the Project on GitHub <small>svofski/videoconditioner</small></a></p>


        <ul>
          <li><a href="https://github.com/svofski/videoconditioner/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/svofski/videoconditioner/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/svofski/videoconditioner">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a id="non-standard-rgb-video-conditioner" class="anchor" href="#non-standard-rgb-video-conditioner" aria-hidden="true"><span class="octicon octicon-link"></span></a>Non-standard RGB video conditioner</h1>

<h1>
<a id="rgb-video-input-for-altera-de1-board--pal-modulator" class="anchor" href="#rgb-video-input-for-altera-de1-board--pal-modulator" aria-hidden="true"><span class="octicon octicon-link"></span></a>RGB video input for Altera DE1 board + PAL Modulator</h1>

<p>This is an experimental video capture project. 
The goal is to capture poorly modulated RGB + Sync signal as produced by an old Soviet home PC,
detect sync, massage the signal levels, insert correct sync pulses, add PAL colour modulation
and output a signal that would be acceptable by a modern colour TV.</p>

<p>Вектор-06ц is the particular computer that I had in mind. Its video generation circuit is
infamous for blatant disregard of all existing video standards at once, which makes it
rather difficult to connect it to modern monitors and televisions.</p>

<h2>
<a id="outline" class="anchor" href="#outline" aria-hidden="true"><span class="octicon octicon-link"></span></a>Outline</h2>

<p>The main platform is Altera DE1 FPGA board. It is fairly outdated, but it's the one that I have
on my bench. Going up to more modern FPGA kits is easy.</p>

<p>A working PAL modulator that works well in my <a href="https://github.com/svofski/vector06cc">vector06cc FPGA
replica</a> of the same computer already exists.</p>

<p>To sample RGB + Sync video signal one needs a decent speed ADC, preferrably with 4 channels,
or a special video capture chip. I found nothing that would suit the job easily available.
However, I found out about a neat trick of using LVDS input pairs available on FPGA chips
to implement custom sigma-delta ADC. No need for special chips!</p>

<p>The basic working principles of such ADC are described in the paper called
<a href="http://www.embedded.com/design/configurable-systems/4008891/Leveraging-FPGA-and-CPLD-digital-logic-to-implement-analog-to-digital-converters">"Leveraging FPGA and CPLD digital logic to implement analog to digital converters"</a> 
by Ted Marena. There's also an excellent explanation and demonstration of the principle in <a href="http://www.youtube.com/watch?v=DTCtx9eNHXE">One Bit ADC</a>
video by Jeri Ellsworth.</p>

<h2>
<a id="block-diagram" class="anchor" href="#block-diagram" aria-hidden="true"><span class="octicon octicon-link"></span></a>Block diagram</h2>

<p>Here's a simplified diagram of the project:</p>

<p><img src="/screenshots/diagram.png" alt="Diagram"></p>

<p>The video signal comprised of H+V composite sync and R, G, B signals is level-shifted to be within
range of LVDS inputs (see schematic) and is fed into the ADC. The ADC modules feed back the resulting
PDM signal to the negative side of LVDS inputs, and to the input averaging filter. The recovered
PCM signal is formed on the output of the filter. There are variations of input filters in the source code.</p>

<p>The recovered sync signal is passed to the input of sync detector module, which tries its best to 
recover horizontal and vertical sync pulses. It's designed to be able to cope with bizarre sync signals
produced by bizarre computers. It does the job with variable success. Usually the problems are of electrical
rather than of logical nature. For example, Вектор-06ц is known to have no equalization pulses, which
results in huge amplitude jumps during vertical sync or even simply empty lines.</p>

<p>The resulting sync, R, G, B signals are fed into the video generator module. It consists of sync generator
and PAL modulator. The outputs are chroma, luma and mixed CVBS composite signals. They are output either
using primitive linear DAC on VGA connector of DE1 board, or using a sigma-delta modulator. The latter
allows for having separate luma + chroma (S-Video) signals on the output. </p>

<h2>
<a id="generating-output" class="anchor" href="#generating-output" aria-hidden="true"><span class="octicon octicon-link"></span></a>Generating output</h2>

<p>S-video using a sigma-delta DAC is very simple:</p>

<pre><code>reg [DAC_RESOLUTION:0] ydac;
reg [DAC_RESOLUTION:0] cdac;
always @(posedge clk_out)
begin
    ydac &lt;= ydac[DAC_RESOLUTION-1:0] + tv_luma[RESOLUTION-1:RESOLUTION-DAC_RESOLUTION]; 
    cdac &lt;= cdac[DAC_RESOLUTION-1:0] + tv_chroma[RESOLUTION-1:RESOLUTION-DAC_RESOLUTION]; 
end

assign GPIO_0[10] = ydac[DAC_RESOLUTION];
assign GPIO_0[11] = cdac[DAC_RESOLUTION];
</code></pre>

<p>Linear DAC on VGA pins of DE1 board is more interesting. The resistor DAC on DE1 allows 4 bits per channel,
or just 16 levels. This is not a lot for composite analog video. Here's what a saw waveform looks like
if only 4 bits are used:</p>

<p><img src="/screenshots/4-bits-RGB-all-equal.jpg" alt="4 bits DAC saw wave"> </p>

<p>However with a little bit of magic, <a href="http://sensi.org/%7Esvo/de1videodac/">described in detail in my article here</a>,
it is possible to get much higher resolution from this DAC. Here's an example:</p>

<p><img src="/screenshots/linearized.jpg" alt="Linearized saw wave"></p>

<p>The magic DAC is implemented using a look-up table:</p>

<pre><code>dactable dactaklakpak(.address(tv_cvbs), .clock(clkpalFSC), .q(dacval));
assign VGA_R = dacval[3:0];
assign VGA_G = dacval[7:4];
assign VGA_B = dacval[11:8];
</code></pre>

<h1>
<a id="project-files" class="anchor" href="#project-files" aria-hidden="true"><span class="octicon octicon-link"></span></a>Project files</h1>

<ul>
<li>
<a href="hw">hw</a> contains KiCad files for the DE1 addon board. Check out the <a href="hw/videoadc.pdf">schematic</a>.</li>
<li>
<a href="iverilog">iverilog</a> contains simulation of video signals as produced by BK-0010, and their detection</li>
<li>
<a href="src">src</a> Altera Quartus II project and synthesizable core</li>
</ul>

<h1>
<a id="results" class="anchor" href="#results" aria-hidden="true"><span class="octicon octicon-link"></span></a>Results</h1>

<p>The input board looks like this:</p>

<p><a href="https://www.flickr.com/photos/svofski/14707757370/"><img src="https://farm4.staticflickr.com/3851/14707757370_ebe90085c4_n.jpg" alt="ADC"></a></p>

<p>Single channel, B&amp;W+Sync only with BK-0010:</p>

<p><a href="https://www.flickr.com/photos/svofski/14770105076/"><img src="https://farm4.staticflickr.com/3897/14770105076_e5189985cd_m.jpg" alt="BK-0010"></a></p>

<p>Single channel passthrough from C64. Signal sampled and output on DE1 VGA pins without any conditioning.</p>

<p><a href="https://www.flickr.com/photos/svofski/14606473808/"><img src="https://farm4.staticflickr.com/3893/14606473808_44bb70ef14_m.jpg" alt="Graphics by Crest/Oxyron"></a></p>

<p>RGB+Sync from Vector-06c</p>

<p><a href="https://www.flickr.com/photos/svofski/14721995768/"><img src="https://farm6.staticflickr.com/5581/14721995768_ecebc7f1ab_n.jpg" alt="Vector-06c b2m test"></a></p>

<p><a href="http://zx-pk.ru/showthread.php?t=23833">Work log on a forum (in Russian)</a></p>

<h1>
<a id="conclusion" class="anchor" href="#conclusion" aria-hidden="true"><span class="octicon octicon-link"></span></a>Conclusion</h1>

<p>This is a research project and I never made it into a finished box with just power plug
and connectors. It works, but is not perfect. The results on my monitor are acceptable.
There were some problems with PAL encoding that I could not resolve that I observed on a couple of older TV sets. 
They are not related to the main focus of the project however: sampling video signals using nothing but a few LVDS pins.</p>

<p>It is definitely possible to capture low-spec video signals with a 10 year old FPGA using
only a few additional discrete components. The practical aspects of this
depend on the situation. Where reliability matter and source signal is known to be
within the specifications, a dedicated chip
like TVP7002 would most likely do better. One interesting example of a project that uses TVP7002
is <a href="http://www.rpg.fi/desaster/blog/2013/04/19/vga-framegrabbing-with-tvp7002/">Grabor</a>.
But with a such chip I would not be able to extract nonstandard 
video signal from Вектор-06ц, just like my monitor cannot do that. Where flexibility and fine control is
required, being able to implement video decoding on the lowest possible level can be beneficial.</p>

<h1>
<a id="references" class="anchor" href="#references" aria-hidden="true"><span class="octicon octicon-link"></span></a>References</h1>

<ul>
<li>
<a href="/whitepapers/CreatingAnADCUsingFPGAResources.PDF">Leveraging FPGA and CPLD Digital Logic to Implement Analog To Digital Converters</a> LatticeSemi Whitepaper</li>
<li>
<a href="/whitepapers/SimpleSigmaDeltaADCDocumentation.PDF">Simple Sigma-Delta ADC</a> LatticeSemi RD1066</li>
</ul>

<hr>

<p>2014-2015 Viacheslav Slavinsky, <a href="http://sensi.org/%7Esvo">http://sensi.org/~svo</a></p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/svofski">svofski</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-3398743-2");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
